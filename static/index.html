<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–µ–≥–µ—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; }
        #controls { 
            padding: 15px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-bottom: 2px solid #e0e6ed; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #map { height: calc(100vh - 140px); }
        #colorbar { 
            height: 50px; 
            background: white; 
            padding: 10px; 
            border-top: 1px solid #ddd;
            display: flex; 
            align-items: center; 
        }
        #stats { margin-top: 8px; font-weight: 600; color: #2c3e50; }
        button, select { 
            background: #3498db; color: white; border: none; 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; 
            margin-right: 10px; font-weight: 500;
        }
        button:hover { background: #2980b9; transform: translateY(-1px); }
        select { background: white; color: #2c3e50; }
        .status { background: #e8f5e8; padding: 8px 12px; border-radius: 4px; border-left: 4px solid #27ae60; }
        .tools-info { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="controls">
        <span style="font-size: 18px; font-weight: bold; color: #2c3e50;">–ò–Ω–¥–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</span>
        <select id="indexSelect">
            <option value="ndvi">NDVI</option>
            <option value="ndwi">NDWI</option>
            <option value="evi">EVI</option>
            <option value="savi">SAVI</option>
            <option value="gndvi">GNDVI</option>
        </select>
        <button onclick="clearSelection()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button onclick="goToSPb()">–°–ü–± –¶–µ–Ω—Ç—Ä</button>
        <div class="tools-info">
        <b>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</b> –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ | –∫—Ä—É–≥ | –º–∞—Ä–∫–µ—Ä
        </div>
        <div id="stats" class="status">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–µ–∫—Å –∏ –Ω–∞—Ä–∏—Å—É–π—Ç–µ –æ–±–ª–∞—Å—Ç—å!</div>
    </div>

    <div id="map"></div>
    
    <div id="colorbar">
        <span>–õ–µ–≥–µ–Ω–¥–∞: </span>
        <img id="colorbarImg" src="" style="height: 30px; margin-left: 10px;" />
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <script>
        const map = L.map('map').setView([59.9386, 30.3141], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        const drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                rectangle: {
                    shapeOptions: {
                        color: '#e74c3c',
                        weight: 3,
                        opacity: 0.9,
                        fillOpacity: 0.1
                    }
                },
                circle: {
                    shapeOptions: {
                        color: '#3498db',
                        weight: 3,
                        fillColor: '#3498db',
                        fillOpacity: 0.1
                    }
                },
                marker: {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiM1N2QxODciLz4KPC9zdmc+Cg==',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                },
                polygon: false,
                polyline: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                edit: false,
                remove: true
            }
        });
        map.addControl(drawControl);
        
        let rasterLayer = null;
        let currentIndex = 'ndvi';
        
        document.getElementById('indexSelect').addEventListener('change', e => {
            currentIndex = e.target.value;
        });
        
        map.on(L.Draw.Event.CREATED, function(event) {
            const layer = event.layer;
            
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            
            const bounds = layer.getBounds();
            const bbox = [
                bounds.getWest(),
                bounds.getSouth(),
                bounds.getEast(),
                bounds.getNorth()
            ];
            
            console.log(`üìê –§–æ—Ä–º–∞: ${event.layerType}, –æ–±–ª–∞—Å—Ç—å:`, bbox);
            calculateIndex(bbox);
        });
        
        function calculateIndex(bbox) {
            document.getElementById('stats').textContent = `–í—ã—á–∏—Å–ª—è—é ${currentIndex.toUpperCase()}...`;
            
            fetch(`/calculate/${currentIndex}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ bbox: bbox })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('stats').innerHTML = `<span style="color: #e74c3c;">${data.error}</span>`;
                    return;
                }
                
                if (rasterLayer) map.removeLayer(rasterLayer);
                
                const imageUrl = 'data:image/png;base64,' + data.image;
                const imgBounds = [[data.bounds[0], data.bounds[1]], [data.bounds[2], data.bounds[3]]];
                
                rasterLayer = L.imageOverlay(imageUrl, imgBounds, { 
                    opacity: 0.75,
                    interactive: true 
                }).addTo(map);
                
                document.getElementById('colorbarImg').src = 'data:image/png;base64,' + data.colorbar;
                document.getElementById('stats').innerHTML = 
                    `<span class="status">‚úÖ ${data.index_name}: ${data.stats.min.toFixed(3)} ‚Ä¶ ${data.stats.max.toFixed(3)}</span>`;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('stats').innerHTML = 
                    '<span style="color: #e74c3c;">–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (python app.py)</span>';
            });
        }
        
        function clearSelection() {
            drawnItems.clearLayers();
            if (rasterLayer) { 
                map.removeLayer(rasterLayer); 
                rasterLayer = null; 
            }
            document.getElementById('stats').innerHTML = 
                '<span class="status">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–µ–∫—Å –∏ –æ–±–ª–∞—Å—Ç—å!</span>';
            document.getElementById('colorbarImg').src = '';
        }
        
        function goToSPb() { 
            map.setView([59.9343, 30.3351], 14); 
            clearSelection(); 
        }
        
        setTimeout(() => {
            console.log('–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫, –∫—Ä—É–≥, –º–∞—Ä–∫–µ—Ä');
            console.log('–ò–∫–æ–Ω–∫–∏ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–∞—Ä—Ç—ã');
        }, 1000);
    </script>
</body>
</html>
